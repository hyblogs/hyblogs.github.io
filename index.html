## SpringCloud-Alibaba集成Nacos+Dubbo

版本信息：

| 组件  | 版本  | 备注  |
| --- | --- | --- |
| spring-cloud-dependencies | 2021.0.1 |     |
| spring-cloud-alibaba-dependencies | 2021.0.1.0 |     |
| spring-boot | 2.6.4 |     |

### 问题一：

服务启动时出现循环依赖问题，如下错误：

```java
2022-03-05 16:22:45.591  INFO 25933 --- [           main] c.a.c.d.s.DubboGenericServiceFactory     : The Dubbo GenericService ReferenceBeans are destroying...
2022-03-05 16:22:45.592  INFO 25933 --- [           main] f.a.ReferenceAnnotationBeanPostProcessor : class org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor was destroying!
2022-03-05 16:22:45.600  INFO 25933 --- [           main] ConditionEvaluationReportLoggingListener : 

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-03-05 16:22:45.629 ERROR 25933 --- [           main] o.s.b.d.LoggingFailureAnalysisReporter   : 

***************************
APPLICATION FAILED TO START
***************************

Description:

The dependencies of some of the beans in the application context form a cycle:

   targeterBeanPostProcessor defined in class path resource [com/alibaba/cloud/dubbo/autoconfigure/DubboOpenFeignAutoConfiguration.class]
      ↓
   com.alibaba.cloud.dubbo.metadata.repository.DubboServiceMetadataRepository (field private com.alibaba.cloud.dubbo.service.DubboMetadataServiceProxy com.alibaba.cloud.dubbo.metadata.repository.DubboServiceMetadataRepository.dubboMetadataConfigServiceProxy)
      ↓
   com.alibaba.cloud.dubbo.service.DubboMetadataServiceProxy
┌─────┐
|  com.alibaba.cloud.dubbo.autoconfigure.DubboMetadataAutoConfiguration (field private com.alibaba.cloud.dubbo.metadata.resolver.MetadataResolver com.alibaba.cloud.dubbo.autoconfigure.DubboMetadataAutoConfiguration.metadataResolver)
└─────┘


Action:

Relying upon circular references is discouraged and they are prohibited by default. Update your application to remove the dependency cycle between beans. As a last resort, it may be possible to break the cycle automatically by setting spring.main.allow-circular-references to true.题
```

**问题原因：**

因为本次使用使用的是 2.6.4 版本的 SpringBoot ，因为从 2.6 开始，Spring Boot 默认禁用了如下的循环引用：

```java
	@Component
	public class A {

		@Autowired
		protected B b;

	}

	@Component
	public class B {

		@Autowired
		protected A a;

	}
```

Spring Boot 2.6 还将 Spring MVC 默认的请求路径匹配策略从 `AntPathMatcher` 变更为了`PathPatternParser`。

官方文档查看更多变更详情：[https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.6-Release-Notes](https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.6-Release-Notes)

**解决办法：**

在 application.properties 配置文件中打开允许循环引用的配置项，如下：

```java
spring.main.allow-circular-references=true
```

### 问题二：

启动服务的时候，链接不上 127.0.0.1:8848 的 nacos 服务，如下：

```java
2022-03-05 16:28:55.177 ERROR 26288 --- [           main] c.a.c.n.registry.NacosServiceRegistry    : nacos registry, marketing-report-server register failed...NacosRegistration{nacosDiscoveryProperties=NacosDiscoveryProperties{serverAddr='127.0.0.1:8848', username='', password='', endpoint='', namespace='', watchDelay=30000, logName='', service='marketing-report-server', weight=1.0, clusterName='DEFAULT', group='DEFAULT_GROUP', namingLoadCacheAtStart='false', metadata={preserved.register.source=SPRING_CLOUD}, registerEnabled=true, ip='192.168.1.4', networkInterface='', port=8082, secure=false, accessKey='', secretKey='', heartBeatInterval=null, heartBeatTimeout=null, ipDeleteTimeout=null, instanceEnabled=true, ephemeral=true, failureToleranceEnabled=false}, ipDeleteTimeout=null, failFast=true}},

com.alibaba.nacos.api.exception.NacosException: failed to req API:/nacos/v1/ns/instance after all servers([127.0.0.1:8848]) tried: java.net.ConnectException: Connection refused (Connection refused)
	at com.alibaba.nacos.client.naming.net.NamingProxy.reqApi(NamingProxy.java:556) ~[nacos-client-1.4.2.jar:na]
	at com.alibaba.nacos.client.naming.net.NamingProxy.reqApi(NamingProxy.java:498) ~[nacos-client-1.4.2.jar:na]
	at com.alibaba.nacos.client.naming.net.NamingProxy.reqApi(NamingProxy.java:493) ~[nacos-client-1.4.2.jar:na]
```

因为我的 nacos 服务并不在本地机器上，而是在其他机器上，所以应该是配置问题。

**问题原因：**

1、我只在 application.properties 配置文件中配置了dubbo，没配置 nacos，所以默认链接了本地的 nacos 服务，发现链接不上。 

2、我配置的时候在 application.properties 配置文件中配置的参数不对，默认的是这样：

```java
spring.cloud.nacos.config.server-addr=192.168.173.199:8848
```

实际应该是配置成这样：

```java
spring.cloud.nacos.server-addr=192.168.173.199:8848
```

注意，加上第二个配置才能正常启动注册服务成功。

### 问题三：

启动服务的时候无法将 dubbo 服务注册到指定到命名空间(namespace)中去，默认将服务注册到了 public 里面。

**解决办法：**

在 application.properties 配置文件中添加配置指定参数 namespace 即可，如下配置：

```java
dubbo.registry.parameters.[namespace]=137e5de9-b9b9-446e-8b40-095c8e70cdb9
```
